{% extends 'base.html' %}

{% block title %}Appointment #{{ appointment.appointment_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Appointment Details</h2>

    <div class="row">
        <!-- ========================== -->
        <!--   MAIN DETAILS COLUMN      -->
        <!-- ========================== -->
        <div class="col-lg-8 mb-4">
            <!-- Appointment Info Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">#{{ appointment.appointment_number }}</h4>
                    <span>{{ appointment.appointment_date|date:"F d, Y" }} at {{ appointment.appointment_time|time:"g:i A" }}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Patient Details</h5>
                            <p><strong>Name:</strong>  {% with patient_user=appointment.patient.user %}
                        {{ patient_user.get_full_name|default:patient_user.username }}
                    {% endwith %}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Doctor Details</h5>
                            <p><strong>Name:</strong> Dr. {{ appointment.doctor.user.get_full_name }}</p>
                            <p><strong>Specialty:</strong> {{ appointment.doctor.specialization.name|default:"Not Specified" }}</p>
                        </div>
                    </div>
                    <hr>
                    <h5>Appointment Info</h5>
                    <p><strong>Reason for Visit:</strong> {{ appointment.reason|linebreaksbr|default:"Not provided" }}</p>
                    <p>
                        <strong>Appointment Status:</strong> 
                        <span class="badge fs-6 {% if appointment.status == 'confirmed' %}bg-success{% elif appointment.status == 'pending' %}bg-warning text-dark{% elif appointment.status == 'completed' %}bg-primary{% elif appointment.status == 'cancelled' %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ appointment.get_status_display }}
                        </span>
                    </p>
                    <p>
                        <strong>Payment Status:</strong> 
                        <span class="badge fs-6 {% if appointment.payment_status == 'paid' %}bg-success{% else %}bg-warning text-dark{% endif %}">
                            {{ appointment.get_payment_status_display|capfirst }}
                        </span>
                    </p>
                </div>
                <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                    <a href="{% url 'appointment_list' %}" class="btn btn-outline-secondary">Back to Appointment List</a>
                    
                    <!-- Payment button for patient -->
                    {% if user.role == 'patient' and appointment.payment_status != 'paid' and appointment.status != 'cancelled' %}
                        <a href="{% url 'process_payment' appointment.id %}" class="btn btn-success">
                            Pay Now (${{ appointment.doctor.consultation_fee|floatformat:2 }})
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- ============================================= -->
            <!--   REVIEW SECTION (FOR PATIENTS ONLY)          -->
            <!-- ============================================= -->
            {% if user.role == 'patient' %}
                <!-- If the 'can_review' flag from the view is True, show the form to leave a review -->
                {% if can_review %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-info text-white"><h4 class="mb-0">Leave a Review</h4></div>
                    <div class="card-body">
                        <p>Your feedback helps other patients and is greatly appreciated. Please rate your experience with Dr. {{ appointment.doctor.user.last_name }}.</p>
                        <form method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="{{ review_form.rating.id_for_label }}" class="form-label fw-bold">Overall Rating</label>
                                {{ review_form.rating }}
                                {% if review_form.rating.errors %}<div class="text-danger small mt-1">{{ review_form.rating.errors.as_text }}</div>{% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ review_form.comment.id_for_label }}" class="form-label fw-bold">Comment (Optional)</label>
                                {{ review_form.comment }}
                            </div>
                             <div class="form-check mb-3">
                                {{ review_form.is_anonymous }}
                                <label class="form-check-label" for="{{ review_form.is_anonymous.id_for_label }}">
                                    Submit my review anonymously
                                </label>
                            </div>
                            <button type="submit" name="submit_review" class="btn btn-primary">Submit Review</button>
                        </form>
                    </div>
                </div>
                
                <!-- If a review already exists for this appointment, display it instead -->
                {% elif appointment.review %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header"><h4 class="mb-0">Your Review</h4></div>
                    <div class="card-body">
                        <p><strong>Your Rating:</strong> 
                            <span class="text-warning">
                                {% for i in "12345" %}
                                    {% if i|add:0 <= appointment.review.rating %}★{% else %}☆{% endif %}
                                {% endfor %}
                            </span>
                            ({{ appointment.review.rating }} / 5)
                        </p>
                        <p><strong>Your Comment:</strong></p>
                        <blockquote class="blockquote mb-0 bg-light p-3 rounded">
                            <p class="mb-0">{{ appointment.review.comment|linebreaksbr|default:"No comment provided." }}</p>
                        </blockquote>
                    </div>
                </div>
                {% endif %}
            {% endif %}

        </div>

        <!-- ========================== -->
        <!--   SIDE ACTIONS COLUMN      -->
        <!-- ========================== -->
        <div class="col-lg-4 mb-4">
            <!-- Doctor Actions Card -->
            {% if user.role == 'doctor' %}
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">Doctor Actions</h4>
                </div>
                <div class="card-body">
                    <!-- Action 1: Update Status -->
                    <form method="post" class="mb-3">
                        {% csrf_token %}
                        <label for="status-select" class="form-label"><strong>Update Status</strong></label>
                        <div class="input-group">
                            <select name="status" id="status-select" class="form-select">
                                {% for key, value in status_choices %}
                                    <option value="{{ key }}" {% if appointment.status == key %}selected{% endif %}>{{ value }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" name="update_status" class="btn btn-success">Update</button>
                        </div>
                    </form>

                    <hr>
                    
                    <!-- Action 2: Create or View Medical Record -->

</div>
                </div>
            </div>
            {% endif %}

            <!-- Patient Actions Card -->
            {% if user.role == 'patient' and appointment.status != 'completed' and appointment.status != 'cancelled' %}
             <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">Patient Actions</h4>
                </div>
                <div class="card-body">
                     <label class="form-label"><strong>Need to change the date?</strong></label>
                     <div class="d-grid">
                        <a href="{% url 'reschedule_appointment' appointment.id %}" class="btn btn-warning">Reschedule Appointment</a>
                     </div>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<style>
/* Style the rating select dropdown and textarea */
select, textarea {
    display: block; width: 100%; padding: .375rem .75rem; font-size: 1rem;
    border: 1px solid #ced4da; border-radius: .25rem;
}
</style>
{% endblock %}